# Диаграммы архитектуры InterView System

## 🔄 Полный поток Voice-to-Layout

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                    BROWSER                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ Mic Button  │  │ File Input  │  │ Text Modal  │  │ Refresh Btn │              │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘              │
│         │                 │                 │                 │                   │
│         ▼                 ▼                 ▼                 ▼                   │
└─────────────────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                               API INTEGRATION Layer                               │
│                                                                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   Mod1      │  │   Mod2      │  │   Mod3      │  │   Web       │              │
│  │  Client     │  │  Client     │  │  Client     │  │  Client     │              │
│  │  (8080)     │  │  (8000)     │  │  (9000)     │  │  (5001)     │              │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘              │
│         │                 │                 │                 │                   │
│         ▼                 ▼                 ▼                 ▼                   │
└─────────────────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              Zustand Store                                         │
│                                                                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │    Page     │  │ Generation  │  │   Session   │  │   Error     │              │
│  │   Model     │  │   State     │  │  Manager    │  │  Handler    │              │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                               UI Layer                                            │
│                                                                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │    Toast    │  │    Page     │  │   Component │  │   Unified   │              │
│  │ Notifications │   Renderer   │  │   Palette   │  │   Session   │              │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 🌊 Детальный поток данных

### 1. Voice Input Flow
```
Audio File ──────────────────────────────────────────────┐
                                                         │
FormData ───────────────────────────────────────────────▼
│                                                        │
├─ audio: File                                     ┌─────────────────┐
├─ session_id: uuid                                │   Mod1 Client  │
└─ chunk_id: timestamp                            │                 │
                                                  │ POST /transcribe│
                                  ┌───────────────┤ multipart/form-data
                                  │               └─────────────────┘
                                  ▼                        │
            ┌─────────────────────────────────────┐       │
            │         Mod1 (ASR)                  │       │
            │  ┌─────────────────────────────────┐ │       │
            │  │ Speech Recognition Engine     │ │◄──────┘
            │  └─────────────────────────────────┘ │
            └─────────────────────────────────────┘
                                  │
                                  ▼
                  Transcription Result ──────────┘
```

### 2. NLP Processing Flow  
```
Text Input ────────────────────────────────────────────┐
                                                        │
Mod2Client.ingestCh┌─────────────────────────────────────▼
├─ session_id: uuid                              ┌─────────────────┐
├─ chunk_id: from_mod1                          │   Mod2 Client  │
├─ seq: 1                                        │                 │
├─ lang: "ru-RU"                                 │ POST /v2/ingest │
└─ text: normalized_text                         └─────────────────┘
                                                         │
                                 ┌─────────────────────────┘
                                 ▼
              ┌─────────────────────────────────────┐
              │        Mod2 (NLP Engine)           │
              │  ┌─────────────────────────────────┐ │
              │  │ Named Entity Recognition       │ │
              │  │ Keyphrase Extraction           │ │
              │  │ Sentiment Analysis             │ │
              │  └─────────────────────────────────┘ │
              └─────────────────────────────────────┘
                                 │
                                 ▼
              Entities & Keyphrases ──────────────────┘
```

### 3. Visual Mapping Flow
```
Entities List ─────────────────────────────────────────┐
                                                      │
Mod3Client.mapEnti┌─────────────────────────────────────▼
├─ session_id: uuid                              ┌─────────────────┐
├─ entities: ["office", "buttons", "footer"]     │   Mod3 Client  │
├─ keyphrases: ["build site", "with buttons"]   │                 │
└─ template: "hero-main-footer"                 │ POST /v1/map   │
                                                 └─────────────────┘
                                                         │
                                 ┌─────────────────────────┘
                                 ▼
              ┌─────────────────────────────────────┐
              │      Mod3 (Visual Engine)          │
              │  ┌─────────────────────────────────┐ │
              │  │ Component Matching            │ │
              │  │ Layout Generation              │ │
              │  │ Props Optimization             │ │
              │  │ Confidence Scoring             │ │
              │  └─────────────────────────────────┘ │
              └─────────────────────────────────────┘
                                 │
                                 ▼
                    Layout + Components ──────────────┘
```

### 4. Storage Flow
```
PageModel ──────────────────────────────────────────┐
                                                    │
WebClient.saveLay┌─────────────────────────────────────▼
├─ sessionId: uuid                              ┌─────────────────┐
└─ layout: PageModel                           │   Web Backend   │
                                               │                 │
                           ┌───────────────────┤ POST /web/v1/   │
                           │                   │ session/{id}/   │
                           ▼                   │ layout          │
              ┌─────────────────────────────┐ │                 │
              │    Backend Database         │ │                   │
              │  ┌─────────────────────────┐ │ │                   │
              │  │ PostgreSQL/MongoDB     │ │ │                   │
              │  │ Session Storage         │ │ │                   │
              │  │ Layout Persistence     │ │ │                   │
              │  │ Metadata Tracking       │ │ │                   │
              │  └─────────────────────────┘ │ │                   │
              └─────────────────────────────┘ │                   │
                             ▲                └─────────────────┘
                             │                         │
                             └─────────────────────────┘
```

## 🔄 WebSocket vs REST API сравнение

### WebSocket (Mod1 Real-time)
```
Browser ────► WebSocket Conn 
             │
             ├───► Audio Stream ────► Mod1 WSS ────► Real-time Transcription
             │
             └───► Fallback to REST (if WSS fails)
```

### REST API (All modules)
```
Browser ────► HTTP Request ────► Module Endpoint ────► JSON Response
             │                       │                      │
             ├───► Headers: Authorization              ├───► Success: 
             ├───► Headers: X-Request-Id                │     { data: {...} }
             ├───► Headers: X-Session-Id               │
             └───► Headers: X-Client: interview-web    └───► Error:
                                                            { error: "..." }
```

## 📊 Error Handling Flow

```
API Call ─────────────────────────────────────────┐
                                                  │
┌─────────────────────────────────────────────────▼
│               fetchJson()                      │
│  ┌─────────────────────────────────────────┐   │
│  │ Attempt 1: Try request                  │   │
│  └─────────────────────────────────────────┘   │
│                         │                     │
│                         ▼                     │
│  ┌─────────────────────────────────────────┐   │
│  │ Success? ─── YES ──► Return result      │   │
│  │   NO                                    │   │
│  │   │                                    │   │
│  │   ▼                                    │   │
│  │ ┌─────────────────────────────────┐   │   │
│  │ │ 5xx Error? ─── YES ──► Retry     │   │   │
│  │ │    NO                           │   │   │
│  │ │    │                           │   │   │
│  │ │    ▼                           │   │   │
│  │ │ Return Error Response          │   │   │
│  │ └─────────────────────────────────┘   │   │
│  └─────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘
```

## 🔧 State Management Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Zustand Store (usePageStore)                      │
│                                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                 │
│  │   Session ID    │  │   Page Model    │  │  Editor Mode    │                 │
│  │   ┌─────────┐   │  │   ┌─────────┐   │  │   ┌─────────┐   │                 │
│  │   │ UUID    │   │  │   │ Blocks  │   │  │   │ view/   │   │                 │
│  │   │ Storage │   │  │   │ Array   │   │  │   │ edit   │   │                 │
│  │   └─────────┘   │  │   └─────────┘   │  │   └─────────┘   │                 │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                 │
│           │                      │                      │                      │
│           ▼                      ▼                      ▼                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │
│  │ Generation      │  │ Component       │  │ Error State     │              │
│  │    State        │  │    Catalog      │  │    Handler      │              │
│  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │              │
│  │ │ Progress    │ │  │ │ Components  │ │  │ │ Error Msg   │ │              │
│  │ │ Step        │ │  │ │ Loading     │ │  │ │ Recovery    │ │              │
│  │ │ Result      │ │  │ │ Loading     │ │  │ │ Actions     │ │              │
│  │ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │              │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Action Functions                                   │
│                                                                                 │
│  generateFromVoice()  ──────► Mod1 → Mod2 → Mod3 → Web                      │
│  generateFromText()   ──────► Mod2 → Mod3 → Web                              │
│  refreshMod3Layout()  ──────► Mod3 → Update Store                             │
│  loadExisting()      ──────► Web → Restore Store                              │
│  saveDebounced()     ──────► Web → Persist Changes                           │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 🌐 Network Layer Architecture

### Request Headers (Автоматически)
```
X-Client: interview-web
X-Request-Id: uuid4() generated per request
X-Session-Id: persistent session from localStorage
Content-Type: application/json (or multipart/form-data)
```

### Response Format (Стандартизирован)
```json
{
  "status": "ok|error",
  "data": { /* whatever the module returns */ },
  "error": "error message if status=error",
  "statusCode": 200,
  "requestId": "uuid",
  "sessionId": "uuid", 
  "source": "mod1|mod2|mod3|web-backend",
  "timestamp": "2025-07-29T..."
}
```

### Retry Strategy
```
Attempt 1 ─────► 429/5xx ─────► Wait 1s ─────► Attempt 2 ─────► 429/5xx ─────► Wait 2s ─────► Attempt 3 ─────► Final Result
     │              │                                │                                 │                   │
     ▼              │                                ▼                                 │                   ▼
  Success ──────────┴───────────────────────── Success ──────────────────────────┤              Success/Error
```

---

*Архитектурные диаграммы обновлены: {{ current_date }}*

