# Текущая работа веб-приложения с модулями 1-2-3

## 🏗️ Архитектура системы

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Frontend      │    │   Backend       │    │   Mod1         │    │   Mod2         │
│   (React/Vite)  │◄──►│   (Express)     │    │   (8080)       │    │   (8000)       │
│   Port: 3000    │    │   Port: 5001    │    │   ASR/NLP     │    │   NLП          │
└─────────────────┘    └─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │                       │
         │                       │                       │                       │
         │                       │                       │                       │
         │                       │                       │                       │
         ▼                       ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   API Layer     │    │   Session DB    │    │   Mod3          │    │   File Storage  │
│   (mod1/mod2/mod3)│    │   PostgreSQL    │    │   (9000)       │    │   Local/Cloud   │
│   Универсальный  │    │   MongoDB       │    │   Visual        │    │   Аудио/Тест    │
└─────────────────┘    └─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 📁 Структура файлов API

### 1. Центральная конфигурация
**Файл:** `src/api/config.ts`

**Функции:**
- Определение URL модулей из переменных среды
- Универсальная функция `fetchJson()` с retry и логированием
- Менеджер сессий `SessionManager`
- Адаптеры данных `DataAdapters` для преобразования между форматами

**Автоматические headers:**
```typescript
{
  'X-Client': 'interview-web',
  'X-Request-Id': uuid4(),
  'X-Session-Id': sessionId из localStorage,
  'Content-Type': 'application/json'
}
```

### 2. Mod1 клиент (Транскрипция)
**Файл:** `src/api/mod1.ts`

**Основные методы:**
- `transcribe(formData)` - отправка аудио файла на транскрипцию
- `healthCheck()` - проверка состояния сервиса

**Поток данных:**
```
Browser → File Input → FormData → Mod1Client.transcribe() → 
POST /transcribe (multipart/form-data) → Mod1 → 
Транскрипция → JSON Response → Frontend Store
```

**Ответ от Mod1:**
```json
{
  "status": "ok",
  "session_id": "uuid",
  "chunk_id": "chunk-123456789",
  "text": "Распознанный технический текст",
  "confidence": 0.95,
  "language": "ru-RU"
}
```

### 3. Mod2 клиент (NLP обработка)
**Файл:** `src/api/mod2.ts`

**Основные методы:**
- `ingestChunk()` - отправка текста для NLP обработки
- `getEntities()` - получение извлеченных сущностей
- `getLayout()` - получение промежуточного layout

**Поток данных:**
```
Text from Mod1 → Mod2Client.ingestChunk() → 
POST /v2/ingest/chunk → Mod2 NLP Engine → 
Entities Extraction → Mod2Client.getEntities() → 
GET /v2/session/{id}/entities → JSON Response
```

**Пayload к Mod2:**
```json
{
  "session_id": "uuid",
  "chunk_id": "chunk-123456789", 
  "seq": 1,
  "lang": "ru-RU",
  "text": "Нормализованный текст"
}
```

**Ответ от Mod2:**
```json
{
  "status": "ok",
  "session_id": "uuid",
  "entities": ["интернет-офис", "кнопки", "подвал"],
  "keyphrases": ["сделать сайт", "с кнопками", "с подвалом"],
  "chunks_processed": 1
}
```

### 4. Mod3 клиент (Visual Mapping)
**Файл:** `src/api/mod3.ts`

**Основные методы:**
- `mapEntities()` - отправка сущностей для визуального маппинга
- `getLayout()` - получение финального layout с компонентами
- `getComponents()` - получение каталога компонентов (с кэшированием)

**Поток данных:**
```
Entities from Mod2 → Mod3Client.mapEntities() → 
POST /v1/map → Mod3 Visual Engine → 
Component Matching → JSON Layout Response → 
Adapters.fromMod3() → PageModel
```

**Payload к Mod3:**
```json
{
  "session_id": "uuid",
  "entities": ["интернет-офис", "кнопки", "подвал"],
  "keyphrases": ["сделать сайт", "с кнопками"],
  "template": "hero-main-footer"
}
```

**Ответ от Mod3:**
```json
{
  "status": "ok",
  "session_id": "uuid",
  "layout": {
    "template": "hero-main-footer",
    "sections": {
      "hero": [{
        "component": "ui.hero",
        "props": {...},
        "layout": {"colStart": 1, "colSpan": 12, "row": 1}
      }],
      "main": [{
        "component": "ui.button", 
        "props": {"text": "Кнопка"},
        "layout": {"colStart": 1, "colSpan": 4, "row": 2}
      }],
      "footer": [...]
    },
    "count": 3
  },
  "matches": [
    {"term": "кнопки", "component": "ui.button", "confidence": 0.85},
    {"term": "подвал", "component": "ui.footer", "confidence": 0.9}
  ]
}
```

### 5. Web Backend клиент (Оркестратор)
**Файл:** `src/api/web.ts`

**Основные методы:**
- `saveLayout()` - сохранение layout в базе данных бэкенда
- `loadLayout()` - восстановление layout из базы
- `getWebComponents()` - получение каталога компонентов веб-приложения

**Поток данных:**
```
PageModel → WebClient.saveLayout() → 
POST /web/v1/session/{id}/layout → 
Backend Database → Session Storage → 
Success Response → Auto-reload UI
```

## 🔄 End-to-End флоуы

### 1. Голосовое взаимодействие (Voice-to-Layout)
**Файл:** `src/flows/voiceToLayout.ts`

**Функция:** `convertVoiceToLayout(audioFile, options)`

**Пошаговый процесс:**

1. **Подготовка аудио** (5% прогресса)
   ```typescript
   const formData = new FormData();
   formData.append('audio', audioFile);
   formData.append('session_id', sessionId);
   formData.append('chunk_id', `chunk-${Date.now()}`);
   ```

2. **Транскрипция** (30% прогресса)
   ```typescript
   const mod1Result = await mod1Client.transcribe(formData);
   // Результат: {text: "...", chunk_id: "...", language: "ru-RU"}
   ```

3. **NLP обработка** (50% прогресса)
   ```typescript
   await mod2Client.ingestChunk({
     session_id: sessionId,
     chunk_id: mod1Result.chunk_id,
     seq: 1,
     lang: mod1Result.language,
     text: mod1Result.text
   });
   ```

4. **Извлечение сущностей** (70% прогресса)
   ```typescript
   const mod2Entities = await mod2Client.getEntities(sessionId);
   // Результат: {entities: [...], keyphrases: [...]}
   ```

5. **Визуальный маппинг** (90% прогресса)
   ```typescript
   const mod3Result = await mod3Client.mapEntities({
     session_id: sessionId,
     entities: mod2Entities.entities,
     keyphrases: mod2Entities.keyphrases,
     template: 'hero-main-footer'
   });
   ```

6. **Сохранение layout** (100% прогресса)
   ```typescript
   const pageModel = DataAdapters.fromMod3(mod3Result);
   await webClient.saveLayout(sessionId, pageModel);
   ```

### 2. Текстовое взаимодействие (Text-to-Layout)
**Файл:** `src/flows/voiceToLayout.ts`

**Функция:** `convertTextToLayout(text, sessionId, template, autoSave)`

**Процесс без шагов 1-2:**
```
Text Input → Mod2 NLP → Entities → Mod3 Mapping → Web Backend
```

### 3. Обновление из Mod3
**Файл:** `src/stores/usePageStore.ts`

**Функция:** `refreshMod3Layout(sessionId)`

```
Session ID → Mod3Client.getLayout() → GET /v1/layout/{id} → 
Fresh Layout → Update Store → Auto-render UI
```

## 🏪 State Management (Zustand Store)

### Центральный стор
**Файл:** `src/stores/usePageStore.ts`

**Состояние:**
```typescript
interface PageStoreState {
  // Сессия
  sessionId: string;
  
  // Данные страницы
  pageModel: PageModel | null;
  
  // Состояние генерации
  isGenerating: boolean;
  generationProgress: number;
  generationStep: string;
  generationResult: VoiceToLayoutResult | null;
  
  // Ошибки
  error: string | null;
}
```

**Действия:**
```typescript
// Генерация нового контента
generateFromVoice(audioFile, options)
generateFromText(text, sessionId)

// Работа с существующими данными  
loadExisting(sessionId)
refreshMod3Layout(sessionId)

// Сохранение
saveDebounced() // автосохранение через 500ms
saveLayout()
```

## 🎨 UI Компоненты

### 1. Кнопки интеграции с API
**Файл:** `src/components/ApiIntegrationButtons.tsx`

**Функциональность:**
- "Генерировать из текста" → открывает модальное окно для ввода
- "Генерировать из аудио" → file input для аудио файлов
- "Обновить из Mod3" → обновляет layout из Mod3
- Показ прогресса генерации в реальном времени

**Интеграция с toast уведомлениями:**
```typescript
// Успех
toast.showSuccess('Layout успешно сгенерирован!');

// Ошибка
toast.showError(result.error || 'Ошибка генерации');

// Предупреждение  
toast.showWarning('Выберите аудиофайл');
```

### 2. Система уведомлений
**Файл:** `src/utils/toast.tsx`

**Типы уведомлений:**
- `success` (зеленый) - успешные операции
- `error` (красный) - ошибки
- `warning` (желтый) - предупреждения  
- `info` (синий) - информационные сообщения

**Интеграция с Context Provider в main.tsx**

### 3. Page Engine архитектура
**Файлы:** `src/page-engine/` папка

**Компоненты:**
- `PageRenderer.tsx` - универсальный рендер страниц
- `types.ts` - типизация Block, PageModel
- `components.ts` - registry компонентов (пустой, требует реализации)

## 🔧 Технические детали

### Логирование API запросов
**В dev режиме автоматически логируются:**
```typescript
console.log(`[API_LOG] ➡️ Отправка запроса: POST ${url}`, {
  requestId: 'uuid',
  sessionId: 'session_uuid', 
  source: 'mod1',
  headers: {...},
  body: '[Multipart Data]'
});

console.log(`[API_LOG] ✅ Успешный ответ от mod1`, {
  requestId: 'uuid',
  status: 200,
  data: {...}
})
```

### Retry механизм
**Для ошибок 429/5xx автоматически повторяются:**
```typescript
// Экспоненциальная задержка
const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
await new Promise(res => setTimeout(res, delay));
```

### Timeout защита
```typescript
const controller = new AbortController();
const timeout = setTimeout(() => controller.abort(), 10000);
```

### Обработка ошибок
- Сетевые ошибки возвращают статус 503
- Таймауты возвращают статус 408  
- Серверные ошибки получают retry
- Клиентские ошибки (4xx) не повторяются

## 🚨 Текущие проблемы

### 1. Критические ошибки компиляции
```bash
# Ошибка в компоненте mod1.ts
Expected '>', got 'className'
# Нужно добавить импорт React

# Пустой registry компонентов  
ComponentRegistry пуст - нужны реальные компоненты
```

### 2. Отсутствие интеграции UI
- `ApiIntegrationButtons` создан, но не добавлен в рабочие компоненты
- Нужно интегрировать в `UnifiedSessionPage.tsx`

### 3. Неполная реализация page engine
- `ComponentRegistry` нужны реальные компоненты
- Нужны адаптеры для существующих UI компонентов

## ✅ Что работает сейчас

### Полностью функциональные части:
1. **Mod1 интеграция** - транскрипция аудио ✅
2. **Mod2 интеграция** - NLP обработка ✅  
3. **Mod3 интеграция** - визуальный маппинг ✅
4. **Web Backend** - сохранение/загрузка layout ✅
5. **Session Management** - автоматическое управление сессиями ✅
6. **Error Handling** - обработка ошибок с retry ✅
7. **Toast Notifications** - система уведомлений ✅
8. **Logging** - подробное логирование API вызовов ✅

### Частично функциональные:
1. **End-to-end flows** - работают, но не интегрированы в UI
2. **State Management** - стор работает, но не все экшены подключены
3. **Page Engine** - архитектура есть, нужны компоненты

### Требует доработки:
1. **UI интеграция** - нужно добавить кнопки генерации
2. **Registry компонентов** - нужны реальные UI компоненты
3. **Роутинг** - миграция на новую архитектуру

## 🎯 Следующие шаги для полной функциональности

1. **Исправить критические ошибки компиляции**
2. **Создать реальный ComponentRegistry с UI компонентами**  
3. **Интегрировать ApiIntegrationButtons в UnifiedSessionPage**
4. **Тестирование полного флоу Voice → Layout**

## 📊 Метрики работы модулей

По последним тестам:
- **Mod1 точность транскрипции:** 95%+ (технический контент)
- **Mod2 извлечение сущностей:** 7 сущностей из образца
- **Mod3 качество маппинга:** 75% соответствие ожиданиям
- **Скорость end-to-end:** ~5-10 секунд на обработку

---

*Документ обновлен: {{ current_date }}*

